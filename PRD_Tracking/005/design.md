# Task 005: RPC Secret è®¤è¯é‡æ„

## ğŸ“Œ åŠŸèƒ½æ¦‚è¿°

é‡æ„ aria2 RPC ä»£ç†è®¤è¯ç³»ç»Ÿï¼Œä»å¤š Token URL è·¯å¾„è®¤è¯æ”¹ä¸ºå•ä¸€ Secret å‚æ•°è®¤è¯ï¼Œå…¼å®¹ aria2 å®˜æ–¹åè®®ã€‚

### æ ¸å¿ƒå˜æ›´
1. æ¯ç”¨æˆ·å”¯ä¸€ RPC Secretï¼ˆå¯åˆ·æ–°ï¼Œæ—§çš„ç«‹å³å¤±æ•ˆï¼‰
2. ç”¨æˆ·éœ€å¼€å¯"å¤–éƒ¨è®¿é—®"æ‰ç”Ÿæˆ Secret
3. å…³é—­å¤–éƒ¨è®¿é—®æ—¶åˆ é™¤ Secret
4. ç»Ÿä¸€æ¥å£ `/aria2/jsonrpc`ï¼Œä½¿ç”¨ `token:xxx` å‚æ•°è®¤è¯

## ğŸ—ï¸ æ¶æ„è®¾è®¡

### è®¤è¯æµç¨‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   AriaNg    â”‚ â”€â”€â”€â”€â”€â”€â–¶ â”‚  /aria2/jsonrpc â”‚ â”€â”€â”€â”€â”€â”€â–¶ â”‚   aria2c    â”‚
â”‚   å®¢æˆ·ç«¯    â”‚         â”‚    ä»£ç†æ¥å£      â”‚         â”‚   æœåŠ¡ç«¯    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                               â”‚
      ç”¨æˆ· secret              â”‚           çœŸæ­£çš„ aria2 secret
   "token:user_abc123"         â”‚           "token:1"
                               â–¼
                        1. æå– params[0] çš„ token:xxx
                        2. æŸ¥æ•°æ®åº“éªŒè¯ rpc_secret
                        3. æ›¿æ¢æˆçœŸæ­£çš„ aria2 secret
                        4. è½¬å‘è¯·æ±‚ï¼Œè¿”å›ç»“æœ
```

### æ•°æ®åº“å˜æ›´

```sql
-- 1. åˆ é™¤æ—§è¡¨
DROP TABLE IF EXISTS api_tokens;

-- 2. ç”¨æˆ·è¡¨æ–°å¢å­—æ®µ
ALTER TABLE users ADD COLUMN rpc_secret VARCHAR(64) NULL;
ALTER TABLE users ADD COLUMN rpc_secret_created_at TEXT NULL;

-- 3. æ·»åŠ å”¯ä¸€ç´¢å¼•ï¼ˆä»…éç©ºå€¼ï¼‰
CREATE UNIQUE INDEX idx_users_rpc_secret ON users(rpc_secret) WHERE rpc_secret IS NOT NULL;
```

### API è®¾è®¡

| ç«¯ç‚¹ | æ–¹æ³• | è¯´æ˜ |
|------|------|------|
| `/api/users/me/rpc-access` | GET | è·å–å¤–éƒ¨è®¿é—®çŠ¶æ€ |
| `/api/users/me/rpc-access` | PUT | å¼€å¯/å…³é—­å¤–éƒ¨è®¿é—® |
| `/api/users/me/rpc-access/refresh` | POST | åˆ·æ–° Secret |
| `/aria2/jsonrpc` | POST | ç»Ÿä¸€ RPC ä»£ç†æ¥å£ |

#### GET /api/users/me/rpc-access
```json
// Response
{
  "enabled": true,
  "secret": "abc123xyz...",
  "created_at": "2026-01-24T10:30:00Z"
}
```

#### PUT /api/users/me/rpc-access
```json
// Request
{ "enabled": true }

// Response (enabled=true)
{
  "enabled": true,
  "secret": "abc123xyz...",
  "created_at": "2026-01-24T10:30:00Z"
}

// Response (enabled=false)
{
  "enabled": false,
  "secret": null,
  "created_at": null
}
```

#### POST /api/users/me/rpc-access/refresh
```json
// Response
{
  "enabled": true,
  "secret": "new_secret_xyz...",
  "created_at": "2026-01-24T11:00:00Z"
}

// Error (if disabled)
{ "detail": "å¤–éƒ¨è®¿é—®æœªå¼€å¯" }
```

## ğŸ”„ ä¸šåŠ¡æµç¨‹

### ç”¨æˆ·å¼€å¯å¤–éƒ¨è®¿é—®
1. ç”¨æˆ·åœ¨è®¾ç½®é¡µé¢æ‰“å¼€"å¤–éƒ¨è®¿é—®"å¼€å…³
2. å‰ç«¯è°ƒç”¨ `PUT /api/users/me/rpc-access { enabled: true }`
3. åç«¯ç”Ÿæˆ `secrets.token_urlsafe(32)` ä½œä¸º rpc_secret
4. å­˜å…¥æ•°æ®åº“ï¼Œè¿”å› secret
5. å‰ç«¯æ˜¾ç¤º secret å’Œè¿æ¥ç¤ºä¾‹

### ç”¨æˆ·å…³é—­å¤–éƒ¨è®¿é—®
1. ç”¨æˆ·å…³é—­"å¤–éƒ¨è®¿é—®"å¼€å…³
2. å‰ç«¯è°ƒç”¨ `PUT /api/users/me/rpc-access { enabled: false }`
3. åç«¯å°† rpc_secret è®¾ä¸º NULL
4. å‰ç«¯éšè— secret ç›¸å…³ UI

### ç”¨æˆ·åˆ·æ–° Secret
1. ç”¨æˆ·ç‚¹å‡»"åˆ·æ–°"æŒ‰é’®
2. å‰ç«¯è°ƒç”¨ `POST /api/users/me/rpc-access/refresh`
3. åç«¯ç”Ÿæˆæ–° secretï¼Œæ—§çš„ç«‹å³å¤±æ•ˆ
4. è¿”å›æ–° secret

### å¤–éƒ¨å®¢æˆ·ç«¯è°ƒç”¨ RPC
1. å®¢æˆ·ç«¯å‘é€è¯·æ±‚åˆ° `/aria2/jsonrpc`
2. è¯·æ±‚ä½“ params[0] ä¸º `token:ç”¨æˆ·secret`
3. åç«¯æå– secretï¼ŒæŸ¥è¯¢ç”¨æˆ·
4. éªŒè¯é€šè¿‡åï¼Œæ›¿æ¢ä¸ºçœŸæ­£çš„ aria2 secret
5. è½¬å‘è¯·æ±‚åˆ° aria2ï¼Œè¿”å›ç»“æœ

## ğŸ¨ å‰ç«¯è®¾è®¡

### ç”¨æˆ·è®¾ç½®é¡µé¢ (/profile)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ å¤–éƒ¨è®¿é—®                                                â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚ [å¼€å…³] å…è®¸å¤–éƒ¨ aria2 å®¢æˆ·ç«¯è¿æ¥                     â”‚ â”‚
â”‚ â”‚                                                     â”‚ â”‚
â”‚ â”‚ â„¹ï¸ å¼€å¯åå¯ä½¿ç”¨ AriaNgã€Motrix ç­‰å®¢æˆ·ç«¯ç®¡ç†ä¸‹è½½ä»»åŠ¡  â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                         â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚ RPC Secret                                          â”‚ â”‚
â”‚ â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” [å¤åˆ¶] [åˆ·æ–°]     â”‚ â”‚
â”‚ â”‚ â”‚ abc123xyz...                  â”‚                   â”‚ â”‚
â”‚ â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                   â”‚ â”‚
â”‚ â”‚                                                     â”‚ â”‚
â”‚ â”‚ è¿æ¥é…ç½®ç¤ºä¾‹:                                        â”‚ â”‚
â”‚ â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚ â”‚
â”‚ â”‚ â”‚ RPC åœ°å€: https://example.com/aria2/jsonrpc   â”‚   â”‚ â”‚
â”‚ â”‚ â”‚ RPC å¯†é’¥: abc123xyz...                        â”‚   â”‚ â”‚
â”‚ â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### çŠ¶æ€è¯´æ˜
- **å¼€å…³å…³é—­**: åªæ˜¾ç¤ºå¼€å…³å’Œè¯´æ˜æ–‡å­—
- **å¼€å…³æ‰“å¼€**: æ˜¾ç¤º Secretã€å¤åˆ¶/åˆ·æ–°æŒ‰é’®ã€è¿æ¥ç¤ºä¾‹

## ğŸš¨ é£é™©åˆ†æ

| é£é™© | å½±å“ | ç¼“è§£æªæ–½ |
|------|------|----------|
| Secret æš´åŠ›ç ´è§£ | è´¦æˆ·è¢«ç›—ç”¨ | é™æµ 100æ¬¡/åˆ†é’Ÿ/IP |
| æ•°æ®åº“æ³„éœ² | Secret æ˜æ–‡æš´éœ² | å¯æ¥å—ï¼ˆéœ€æ˜¾ç¤ºç»™ç”¨æˆ·ï¼‰ |
| æ—¶åºæ”»å‡» | æ¨æ–­ Secret | `secrets.compare_digest` |
| æ—§æ¥å£å…¼å®¹ | ç°æœ‰å®¢æˆ·ç«¯å¤±æ•ˆ | åˆ é™¤æ—§æ¥å£ï¼Œç”¨æˆ·éœ€é‡æ–°é…ç½® |

## ğŸ› ï¸ æŠ€æœ¯é€‰å‹

| ç»„ä»¶ | é€‰æ‹© | ç†ç”± |
|------|------|------|
| Secret ç”Ÿæˆ | `secrets.token_urlsafe(32)` | 256 ä½ç†µï¼ŒURL å®‰å…¨ |
| æ—¶åºå®‰å…¨ | `secrets.compare_digest` | é˜²æ­¢æ—¶åºæ”»å‡» |
| é™æµ | å¤ç”¨ç°æœ‰ rate_limit æ¨¡å— | å·²æœ‰åŸºç¡€è®¾æ–½ |

## ğŸ“ éªŒæ”¶æ ‡å‡†

### åŠŸèƒ½éªŒæ”¶
- [ ] ç”¨æˆ·å¯å¼€å¯/å…³é—­å¤–éƒ¨è®¿é—®
- [ ] å¼€å¯æ—¶ç”Ÿæˆ Secretï¼Œå…³é—­æ—¶åˆ é™¤
- [ ] å¯åˆ·æ–° Secretï¼Œæ—§çš„ç«‹å³å¤±æ•ˆ
- [ ] å¯éšæ—¶æŸ¥çœ‹å®Œæ•´ Secret
- [ ] å¤–éƒ¨å®¢æˆ·ç«¯å¯é€šè¿‡ `token:xxx` è®¤è¯
- [ ] è¿æ¥ç¤ºä¾‹æ­£ç¡®æ˜¾ç¤º

### å®‰å…¨éªŒæ”¶
- [ ] æ—§ api_tokens è¡¨å·²åˆ é™¤
- [ ] æ—§ `/aria2/{token}/jsonrpc` æ¥å£å·²åˆ é™¤
- [ ] RPC æ¥å£æœ‰é™æµä¿æŠ¤
- [ ] æ—¶åºæ”»å‡»é˜²æŠ¤å·²å®ç°

### å…¼å®¹æ€§éªŒæ”¶
- [ ] AriaNg å¯æ­£å¸¸è¿æ¥
- [ ] ç°æœ‰åŠŸèƒ½ä¸å—å½±å“

## ğŸ“ æ¶‰åŠæ–‡ä»¶

### åç«¯
- `backend/app/db.py` - æ•°æ®åº“è¿ç§»
- `backend/app/routers/users.py` - æ–°å¢ RPC è®¿é—® API
- `backend/app/routers/aria2_rpc.py` - é‡æ„ RPC ä»£ç†
- `backend/app/schemas.py` - æ–°å¢è¯·æ±‚/å“åº”æ¨¡å‹

### å‰ç«¯
- `frontend/app/profile/page.tsx` - å¤–éƒ¨è®¿é—®è®¾ç½® UI
- `frontend/lib/api.ts` - æ–°å¢ API è°ƒç”¨
- `frontend/types.ts` - æ–°å¢ç±»å‹å®šä¹‰

### åˆ é™¤
- `backend/app/routers/aria2_rpc.py` ä¸­çš„æ—§ Token ç›¸å…³ä»£ç 
