# ChangeLogs

## 2026-01-24 - Token ç³»ç»Ÿé‡æ„ä¸º RPC Secret ç³»ç»Ÿ

### ä»»åŠ¡ç¼–å·: 005

### å˜æ›´èƒŒæ™¯

åŸæœ‰çš„å¤š Token ç³»ç»Ÿå­˜åœ¨ Token URL æ³„éœ²é£é™©ï¼ˆToken åœ¨ URL è·¯å¾„ä¸­ä¼ é€’ï¼Œå¯èƒ½è¢«æ—¥å¿—è®°å½•ï¼‰ã€‚é‡æ„ä¸ºç¬¦åˆ aria2 å®˜æ–¹åè®®çš„ RPC Secret ç³»ç»Ÿã€‚

### å˜æ›´å†…å®¹

#### æ•°æ®åº“å˜æ›´

| å˜æ›´ | è¯´æ˜ |
|------|------|
| åˆ é™¤ `api_tokens` è¡¨ | ä¸å†ä½¿ç”¨å¤š Token æœºåˆ¶ |
| `users` è¡¨æ–°å¢ `rpc_secret` å­—æ®µ | ç”¨æˆ·å”¯ä¸€çš„ RPC Secret |
| `users` è¡¨æ–°å¢ `rpc_secret_created_at` å­—æ®µ | Secret åˆ›å»ºæ—¶é—´ |

#### åç«¯ API å˜æ›´

| æ¥å£ | æ–¹æ³• | è¯´æ˜ |
|------|------|------|
| `/api/users/me/rpc-access` | GET | è·å– RPC è®¿é—®çŠ¶æ€ |
| `/api/users/me/rpc-access` | PUT | å¼€å¯/å…³é—­ RPC è®¿é—® |
| `/api/users/me/rpc-access/refresh` | POST | åˆ·æ–° RPC Secret |
| `/aria2/jsonrpc` | POST | ç»Ÿä¸€ RPC ä»£ç†æ¥å£ï¼ˆä½¿ç”¨ `token:xxx` å‚æ•°è®¤è¯ï¼‰ |

#### åˆ é™¤çš„æ¥å£

| æ¥å£ | è¯´æ˜ |
|------|------|
| `POST /api/tokens` | åˆ›å»º Token |
| `GET /api/tokens` | è·å– Token åˆ—è¡¨ |
| `DELETE /api/tokens/{id}` | åˆ é™¤ Token |
| `GET /aria2/{token}/jsonrpc` | æ—§çš„ URL è·¯å¾„ Token è®¤è¯æ¥å£ |

#### å‰ç«¯å˜æ›´

| æ–‡ä»¶ | å˜æ›´ |
|------|------|
| `frontend/types/index.ts` | æ–°å¢ `RpcAccessStatus` ç±»å‹ |
| `frontend/lib/api.ts` | æ–°å¢ RPC è®¿é—®ç›¸å…³ API è°ƒç”¨ |
| `frontend/app/profile/page.tsx` | é‡æ„ç”¨æˆ·è®¾ç½®é¡µé¢ï¼Œæ·»åŠ å¤–éƒ¨è®¿é—®ç®¡ç† |

### å®‰å…¨æ”¹è¿›

| æ”¹è¿› | è¯´æ˜ |
|------|------|
| Token ä¸å†å‡ºç°åœ¨ URL ä¸­ | é˜²æ­¢æ—¥å¿—æ³„éœ² |
| ä½¿ç”¨ aria2 å®˜æ–¹ `token:xxx` å‚æ•°è®¤è¯ | ç¬¦åˆåè®®æ ‡å‡† |
| å¸¸é‡æ—¶é—´æ¯”è¾ƒ | ä½¿ç”¨ `secrets.compare_digest` é˜²æ­¢æ—¶åºæ”»å‡» |
| æŒ‰éœ€ç”Ÿæˆ Secret | ç”¨æˆ·ä¸å¼€å¯å¤–éƒ¨è®¿é—®æ—¶ä¸ç”Ÿæˆ |
| å…³é—­æ—¶åˆ é™¤ Secret | å…³é—­å¤–éƒ¨è®¿é—®æ—¶ç«‹å³åˆ é™¤ |

### å½±å“èŒƒå›´

- åç«¯: 3 ä¸ªæ–‡ä»¶ä¿®æ”¹ï¼ˆschema.py, users.py, aria2_rpc.pyï¼‰
- å‰ç«¯: 3 ä¸ªæ–‡ä»¶ä¿®æ”¹ï¼ˆtypes/index.ts, lib/api.ts, app/profile/page.tsxï¼‰
- **ç ´åæ€§å˜æ›´**: æ˜¯ï¼ˆæ—§çš„ Token API å’Œ URL è·¯å¾„è®¤è¯æ–¹å¼å·²åˆ é™¤ï¼‰

### è¿ç§»è¯´æ˜

ä½¿ç”¨æ—§ Token ç³»ç»Ÿçš„å¤–éƒ¨å®¢æˆ·ç«¯éœ€è¦ï¼š
1. åœ¨ç”¨æˆ·è®¾ç½®é¡µé¢å¼€å¯"å¤–éƒ¨è®¿é—®"è·å–æ–° Secret
2. å°† RPC åœ°å€æ”¹ä¸º `/aria2/jsonrpc`
3. åœ¨ JSON-RPC params ç¬¬ä¸€ä¸ªå‚æ•°ä½¿ç”¨ `token:xxx` æ ¼å¼

### éªŒæ”¶æ ‡å‡†

- [x] `make build` ç¼–è¯‘é€šè¿‡
- [x] æ•°æ®åº“è¿ç§»æ­£ç¡®
- [x] RPC è®¿é—®ç®¡ç† API æ­£å¸¸
- [x] RPC ä»£ç†æ¥å£æ­£å¸¸
- [x] å‰ç«¯ UI æ­£å¸¸
- [x] ä»£ç å®¡æŸ¥é€šè¿‡

---

## 2026-01-22 - ä¿®å¤ Critical å®‰å…¨/å¥å£®æ€§é—®é¢˜

### ä»»åŠ¡ç¼–å·: 001

### å˜æ›´å†…å®¹

| é—®é¢˜ | ä¿®å¤ | æ–‡ä»¶ |
|------|------|------|
| aria2 å›è°ƒæ¥å£æ— è®¤è¯ | æ·»åŠ  `X-Hook-Secret` Header éªŒè¯ | `routers/hooks.py` |
| SQLite å¹¶å‘å†™å…¥ä¸å®‰å…¨ | æ·»åŠ  `threading.Lock` å†™é” | `db.py` |
| HTTP è¯·æ±‚æ— è¶…æ—¶ | æ·»åŠ  30 ç§’è¶…æ—¶ | `aria2/client.py` |
| æ—¶åŒºæ¯”è¾ƒé™·é˜± | ç¡®ä¿ datetime æœ‰æ—¶åŒºä¿¡æ¯ | `auth.py` |
| WebSocket æ— é‡è¿ | æ·»åŠ  onerror/onclose å¤„ç†ï¼Œ3 ç§’é‡è¿ | `tasks/page.tsx` |

### æ–°å¢é…ç½®é¡¹

| é…ç½® | ç¯å¢ƒå˜é‡ | é»˜è®¤å€¼ | è¯´æ˜ |
|------|---------|--------|------|
| `hook_secret` | `ARIA2C_HOOK_SECRET` | `""` | aria2 å›è°ƒè®¤è¯å¯†é’¥ï¼Œä¸ºç©ºæ—¶ä¸éªŒè¯ |

### å½±å“èŒƒå›´

- åç«¯: 5 ä¸ªæ–‡ä»¶ä¿®æ”¹
- å‰ç«¯: 1 ä¸ªæ–‡ä»¶ä¿®æ”¹
- å‘åå…¼å®¹: æ˜¯ï¼ˆæ–°é…ç½®é»˜è®¤ä¸ºç©ºï¼Œä¸å½±å“ç°æœ‰éƒ¨ç½²ï¼‰

### éªŒæ”¶æ ‡å‡†

- [x] `make build` ç¼–è¯‘é€šè¿‡
- [x] ä»£ç é£æ ¼ä¸€è‡´
- [x] æ— ç ´åæ€§å˜æ›´

---

## 2026-01-22 - ä¿®å¤ P2/P3 ä»£ç è´¨é‡é—®é¢˜

### ä»»åŠ¡ç¼–å·: 002

### å˜æ›´å†…å®¹

#### P2 (Important) ä¿®å¤

| é—®é¢˜ | ä¿®å¤ | æ–‡ä»¶ |
|------|------|------|
| ç™»å½•æ— é€Ÿç‡é™åˆ¶ | åŸºäº IP çš„é€Ÿç‡é™åˆ¶å™¨ (5æ¬¡/5åˆ†é’Ÿ) | `core/rate_limit.py`, `routers/auth.py` |
| è¾“å…¥éªŒè¯ç¼ºå¤± | Pydantic Field çº¦æŸ (é•¿åº¦/èŒƒå›´) | `schemas.py` |
| é…ç½®æŸ¥è¯¢æ— ç¼“å­˜ | 60 ç§’ TTL ç¼“å­˜ | `routers/config.py` |
| åŒæ­¥ä»»åŠ¡ä¸²è¡Œæ‰§è¡Œ | asyncio.gather å¹¶å‘åŒ– | `aria2/sync.py` |
| è·¯å¾„éªŒè¯æ— ç¬¦å·é“¾æ¥æ£€æŸ¥ | ç¬¦å·é“¾æ¥è§£æ+è¾¹ç•Œæ ¡éªŒ | `routers/files.py` |
| å‰ç«¯æ•°å€¼è¾“å…¥æ— é™åˆ¶ | min/max å±æ€§çº¦æŸ | `settings/page.tsx` |

#### P3 (Nit) ä¿®å¤

| é—®é¢˜ | ä¿®å¤ | æ–‡ä»¶ |
|------|------|------|
| èœå•æ´»è·ƒé“¾æ¥é€»è¾‘æœ‰ç¼ºé™· | ç²¾ç¡®åŒ¹é… + å‰ç¼€åŒ¹é… | `components/Sidebar.tsx` |
| é…é¢å•ä½è½¬æ¢é‡å¤ä»£ç  | å·¥å…·å‡½æ•°æŠ½å– | `lib/utils.ts` (æ–°å»º) |
| ç›®å½•å¤§å°è®¡ç®—æ€§èƒ½å·® | 30 ç§’ TTL ç¼“å­˜ | `routers/files.py` |

### æ–°å¢æ–‡ä»¶

| æ–‡ä»¶ | è¯´æ˜ |
|------|------|
| `backend/app/core/rate_limit.py` | ç™»å½•é€Ÿç‡é™åˆ¶å™¨æ¨¡å— |
| `frontend/lib/utils.ts` | å‰ç«¯å·¥å…·å‡½æ•° (bytesToGB, gbToBytes, formatBytes) |

### æœªä¿®å¤é¡¹ (è®¾è®¡å†³å®š)

| é—®é¢˜ | åŸå›  |
|------|------|
| PBKDF2 è¿­ä»£æ¬¡æ•° | 120000 å·²ç¬¦åˆ OWASP 2023 æ ‡å‡† |
| SecretStr ç±»å‹ | å½±å“èŒƒå›´å¤§ï¼Œå½“å‰å®ç°å·²æ»¡è¶³éœ€æ±‚ |

### å½±å“èŒƒå›´

- åç«¯: 6 ä¸ªæ–‡ä»¶ä¿®æ”¹ï¼Œ1 ä¸ªæ–°å»º
- å‰ç«¯: 2 ä¸ªæ–‡ä»¶ä¿®æ”¹ï¼Œ1 ä¸ªæ–°å»º
- å‘åå…¼å®¹: æ˜¯

### éªŒæ”¶æ ‡å‡†

- [x] `make build` ç¼–è¯‘é€šè¿‡
- [x] æ‰€æœ‰ 12 ä¸ªå­ä»»åŠ¡å®Œæˆ
- [x] ä»£ç é£æ ¼ä¸€è‡´
- [x] æ— ç ´åæ€§å˜æ›´

---

## 2026-01-23 - UX å¢å¼ºåŠŸèƒ½

### ä»»åŠ¡ç¼–å·: 003

### å˜æ›´å†…å®¹

#### åŠŸèƒ½ 1: BT ç§å­æ–‡ä»¶ä¸Šä¼ 

| æ”¹åŠ¨ | æ–‡ä»¶ |
|------|------|
| æ·»åŠ  `add_torrent` æ–¹æ³• | `backend/app/aria2/client.py` |
| æ·»åŠ  `POST /api/tasks/torrent` æ¥å£ | `backend/app/routers/tasks.py` |
| æ·»åŠ  `uploadTorrent` API å‡½æ•° | `frontend/lib/api.ts` |
| æ·»åŠ ç§å­ä¸Šä¼ æŒ‰é’®ï¼ˆğŸ“ï¼‰å’Œæ–‡ä»¶é€‰æ‹©å™¨ | `frontend/app/tasks/page.tsx` |

#### åŠŸèƒ½ 2: æµè§ˆå™¨é€šçŸ¥

| æ”¹åŠ¨ | æ–‡ä»¶ |
|------|------|
| æ–°å»ºé€šçŸ¥å·¥å…·æ¨¡å— | `frontend/lib/notification.ts` (æ–°å»º) |
| WebSocket çŠ¶æ€å˜åŒ–æ—¶å‘é€é€šçŸ¥ | `frontend/app/tasks/page.tsx` |
| æ·»åŠ é€šçŸ¥è®¾ç½®å¼€å…³ï¼ˆå¯ç”¨/å®Œæˆé€šçŸ¥/é”™è¯¯é€šçŸ¥ï¼‰ | `frontend/app/settings/page.tsx` |

#### åŠŸèƒ½ 3: ä»»åŠ¡æ‹–æ‹½æ’åº

| æ”¹åŠ¨ | æ–‡ä»¶ |
|------|------|
| æ·»åŠ  `change_position` æ–¹æ³• | `backend/app/aria2/client.py` |
| æ·»åŠ  `PUT /api/tasks/{id}/position` æ¥å£ | `backend/app/routers/tasks.py` |
| æ·»åŠ  `changeTaskPosition` API å‡½æ•° | `frontend/lib/api.ts` |
| æ·»åŠ  dnd-kit ä¾èµ– | `frontend/package.json` |
| å®ç° SortableTaskCard ç»„ä»¶å’Œæ‹–æ‹½é€»è¾‘ | `frontend/app/tasks/page.tsx` |

### æ–°å¢æ–‡ä»¶

| æ–‡ä»¶ | è¯´æ˜ |
|------|------|
| `frontend/lib/notification.ts` | æµè§ˆå™¨é€šçŸ¥å·¥å…·æ¨¡å— |

### æ–°å¢ä¾èµ–

| åŒ…å | ç‰ˆæœ¬ | è¯´æ˜ |
|------|------|------|
| `@dnd-kit/core` | ^6.3.1 | æ‹–æ‹½æ ¸å¿ƒåº“ |
| `@dnd-kit/sortable` | ^10.0.0 | åˆ—è¡¨æ’åºåŠŸèƒ½ |

### æ–°å¢ API

| æ¥å£ | æ–¹æ³• | è¯´æ˜ |
|------|------|------|
| `/api/tasks/torrent` | POST | ä¸Šä¼ ç§å­æ–‡ä»¶åˆ›å»ºä»»åŠ¡ |
| `/api/tasks/{id}/position` | PUT | è°ƒæ•´ä»»åŠ¡åœ¨é˜Ÿåˆ—ä¸­çš„ä½ç½® |

### å½±å“èŒƒå›´

- åç«¯: 2 ä¸ªæ–‡ä»¶ä¿®æ”¹
- å‰ç«¯: 4 ä¸ªæ–‡ä»¶ä¿®æ”¹ï¼Œ1 ä¸ªæ–°å»ºï¼Œ2 ä¸ªä¾èµ–æ–°å¢
- å‘åå…¼å®¹: æ˜¯

### éªŒæ”¶æ ‡å‡†

- [x] `make build` ç¼–è¯‘é€šè¿‡
- [x] æ‰€æœ‰ 13 ä¸ªå­ä»»åŠ¡å®Œæˆ
- [x] TypeScript ç±»å‹æ£€æŸ¥é€šè¿‡
- [x] ä»£ç é£æ ¼ä¸€è‡´
- [x] æ— ç ´åæ€§å˜æ›´
